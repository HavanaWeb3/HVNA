<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
(function(){if(window.HVNA_API)return;window.HVNA_API=true;const API_URL='http://localhost:3001/api';class W{constructor(){this.chain=8453}w(){const d=document.createElement('div');d.id='hvna-widget';d.innerHTML='<div style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:25px;border-radius:12px;margin:20px 0;text-align:center;box-shadow:0 6px 20px rgba(102,126,234,.4)"><div style="font-size:22px;font-weight:700;margin-bottom:12px">ğŸ˜ Exclusive Web3 Discounts</div><div style="margin-bottom:12px;font-size:15px;line-height:1.6"><div><strong>NFT Holders:</strong> Up to 50% off</div><div><strong>Token Holders:</strong> $150+=10% | $300+=20% | $500+=30%</div><div style="font-size:13px;opacity:.9;margin-top:6px">âœ¨ Verified on-chain! One-time use codes</div></div><button id="hvna-connect" style="background:#fff;color:#667eea;padding:16px 32px;border:0;border-radius:10px;font-weight:700;cursor:pointer;font-size:16px;width:100%;box-shadow:0 4px 12px rgba(0,0,0,.2)">ğŸ”— Connect Wallet & Get Discount</button><div id="hvna-msg" style="margin-top:15px;font-size:14px;line-height:1.5"></div></div>';const s=['.shopify-payment-button','.dynamic-checkout__content','[name="add"]','.product-form__submit','.cart__checkout'];for(let e of s){const t=document.querySelector(e);if(t){t.parentNode.insertBefore(d,t.nextSibling);break}}document.getElementById('hvna-connect').onclick=()=>this.connect()}async connect(){const b=document.getElementById('hvna-connect'),m=document.getElementById('hvna-msg');b.textContent='ğŸ”„ Connecting...';b.disabled=true;try{if(!window.ethereum)throw new Error('Install MetaMask or Rabby wallet');const accts=await window.ethereum.request({method:'eth_requestAccounts'});const addr=accts[0];try{await window.ethereum.request({method:'wallet_switchEthereumChain',params:[{chainId:'0x2105'}]})}catch(e){if(e.code===4902)await window.ethereum.request({method:'wallet_addEthereumChain',params:[{chainId:'0x2105',chainName:'Base',nativeCurrency:{name:'ETH',symbol:'ETH',decimals:18},rpcUrls:['https://mainnet.base.org'],blockExplorerUrls:['https://basescan.org']}]})}b.textContent='â³ Verifying holdings...';const resp=await fetch(`${API_URL}/generate-discount`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({walletAddress:addr})});const data=await resp.json();if(!data.success){m.innerHTML='<div style="color:#ffdddd;background:rgba(255,255,255,.15);padding:12px;border-radius:8px"><strong>âŒ No discount</strong><br><div style="font-size:13px;margin-top:8px">You have: '+data.holdings.tokens+' tokens ($'+data.holdings.value+')<br>Need $150+ for 10% off<br>Source: '+data.holdings.source+'</div></div>';b.textContent='âŒ No Discount';b.disabled=false;return}this.showModal(data)}catch(e){console.error(e);m.innerHTML='<div style="color:#ffdddd">âŒ '+e.message+'</div>';b.textContent='ğŸ”— Try Again';b.disabled=false}}showModal(data){const mo=document.createElement('div');mo.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.95);display:flex;align-items:center;justify-content:center;z-index:10000';mo.innerHTML='<div style="background:#fff;padding:40px;border-radius:20px;max-width:500px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.5)"><h3 style="color:#667eea;font-size:32px;margin-bottom:20px;font-weight:800">ğŸ‰ Your Unique Code</h3><div style="background:linear-gradient(135deg,#667eea,#764ba2);padding:30px;border-radius:15px;margin-bottom:25px;cursor:pointer" onclick="navigator.clipboard.writeText(\''+data.code+'\');this.querySelector(\'small\').textContent=\'âœ… Copied!\'"><div style="font-family:monospace;font-size:28px;font-weight:700;color:#fff;letter-spacing:1px;margin-bottom:8px">'+data.code+'</div><small style="font-size:14px;color:rgba(255,255,255,.9)">Click to copy</small></div><div style="background:linear-gradient(135deg,#f093fb,#f5576c);color:#fff;padding:20px;border-radius:12px;margin-bottom:20px"><div style="font-size:28px;font-weight:700;margin-bottom:8px">'+data.discount+'% OFF</div><div style="font-size:16px">'+data.tier+'</div></div><div style="background:#f8f9fa;padding:20px;border-radius:12px;margin-bottom:25px;text-align:left"><div style="font-weight:600;color:#333;margin-bottom:12px;font-size:16px">ğŸ“Š Your Holdings:</div><div style="font-size:14px;color:#666;line-height:1.8"><div>ğŸ’° Tokens: <strong>'+data.holdings.tokens+' HVNA</strong> ($'+data.holdings.value+')</div><div>ğŸ¨ NFTs: <strong>'+data.holdings.nfts+'</strong></div><div>ğŸ“ Source: <strong>'+data.holdings.source+'</strong></div></div></div><div style="background:#fff3cd;border:2px solid #ffc107;color:#856404;padding:15px;border-radius:10px;margin-bottom:20px;font-size:13px"><strong>âš ï¸ ONE-TIME USE ONLY</strong><br>This code expires after first use. Copy it now!</div><button onclick="this.parentElement.parentElement.remove()" style="background:#667eea;color:#fff;padding:16px 50px;border:0;border-radius:12px;cursor:pointer;font-size:18px;font-weight:700;width:100%">Got it! ğŸ</button></div>';document.body.appendChild(mo);navigator.clipboard.writeText(data.code)}init(){if(!window.ethereum){const w=document.createElement('div');w.innerHTML='<div style="background:#ff6b6b;color:#fff;padding:25px;border-radius:12px;margin:20px 0;text-align:center"><div style="font-size:20px;font-weight:700;margin-bottom:12px">ğŸ¦Š Install Web3 Wallet</div><div style="font-size:14px;margin-bottom:18px">Get verified Web3 discounts!</div><a href="https://metamask.io" target="_blank" style="display:inline-block;background:#fff;color:#ff6b6b;padding:12px 24px;border-radius:8px;text-decoration:none;font-weight:600;margin:5px">MetaMask</a><a href="https://rabby.io" target="_blank" style="display:inline-block;background:#fff;color:#ff6b6b;padding:12px 24px;border-radius:8px;text-decoration:none;font-weight:600;margin:5px">Rabby</a></div>';(document.querySelector('.product-form')||document.body).prepend(w);return}this.w()}}if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',()=>new W().init());else new W().init()})();
</script>
